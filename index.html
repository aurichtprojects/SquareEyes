<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>NZ - Weed Management</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Styles -->
    <link rel="stylesheet" href="openlayers/theme/default/style.css" type="text/css">
    <link rel="stylesheet" href="ol-style.css" type="text/css">
    <link href="bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="select2/select2.css" rel="stylesheet"/>
    <style type="text/css">

        body {
            padding: 10px;
        }

        .container-fluid {
            padding: 0;
        }

        /* CSS for a fluid-fixed layout based on http://jsfiddle.net/andresilich/6vPqA/13/ */

        .well {
            padding:9px;
        }

        .fluid-fixed {
        margin-right: 280px;
        margin-left:auto !important;
        display: block;
        }

        .row-fluid > .sidebar-nav {
            position: relative;
            top: 0;
        left:auto;
        width: 250px;
    }

        .right {
            display: block;
            float:right;
    }

    </style>
    <!--<link href="bootstrap/css/bootstrap-responsive.css" rel="stylesheet">-->
    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

  </head>

  <body>

    <div class="container-fluid">
        <div class="row-fluid">
			<!-- the navbar needs to be defined before the fluid content! -->
            <div id="sidebar" class="well right sidebar-nav">
                <!--Sidebar content-->
                <input type="hidden" id="e1" style="width:250px"/>
             </div>
            <div class="well fluid-fixed">
                <!--Body content-->
                <div id="map" class="smallmap"></div>
            </div>

        </div>
    </div>

    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="openlayers/OpenLayers.js"></script>
    <!-- Letting Google host and serve jQuery for us -->
    <!-- based on http://encosia.com/3-reasons-why-you-should-let-google-host-jquery-for-you/ -->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
    <script src="bootstrap/js/bootstrap.js"></script>
    <script src="select2/select2.js"></script>
    <script>

        var vmap, wfs_layer,assets_array,gridMaxRes=200;

        // Window resize function
        var rsz = function(){
            var h = $(window).height();
            var w = $(window).width();
            // Setting height to window height minus the header and footer sizes
            $("#map").css('height',h - 62);
            $("#map").css('width', w - 322);
        };

        // Initial width/height values are required for display of vector layer
        rsz();
        $(window).resize(rsz);

        $(document).ready(function () {

            function initMap(){
                vmap = new OpenLayers.Map('map',
                    {
                        projection: "EPSG:900913",
                        units: "m",
                        maxResolution: 156543.0339,
                        maxExtent: new OpenLayers.Bounds(-20037508.34, -20037508.34, 20037508.34, 20037508.34),
                        controls:[
                            new OpenLayers.Control.Navigation(),
                            new OpenLayers.Control.Zoom(),
                            new OpenLayers.Control.LayerSwitcher({'ascending':false}),
                            new OpenLayers.Control.ScaleLine()
                        ],
                        numZoomLevels:20
                    }
                );

                osm = new OpenLayers.Layer.OSM("Simple OSM Map");
                vmap.addLayer(osm);
                vmap.setCenter(
                    new OpenLayers.LonLat(172, -40).transform(
                        new OpenLayers.Projection("EPSG:4326"),
                        vmap.getProjectionObject()
                    ), 5
                );

                // Style definition for the grid vector layer
                var defaultStyle = new OpenLayers.Style({
                    'strokeColor': 'black',
                    'strokeOpacity': 0.5,
                    'strokeWidth': 0.5,
                    'fillOpacity': 0
                });

                var selectStyle = new OpenLayers.Style({
                    'strokeColor': 'blue',
                    'strokeWidth': 0.5,
                    'fillOpacity': 0.5
                });

                var sm = new OpenLayers.StyleMap({'default': defaultStyle,'select': selectStyle});

                // Vector layer for the grid of cells
                wfs_layer = new OpenLayers.Layer.Vector("Grid", {
                    strategies: [new OpenLayers.Strategy.BBOX()],
                    protocol: new OpenLayers.Protocol.WFS({
                        version: "1.1.0",
                        url: "/geoserver/wfs",
                        featureType: "CELL",
                        featureNS: "http://www.pozi.com/project1",
                        srsName: "EPSG:900913"
                    }),
                    styleMap: sm,
                    maxResolution:gridMaxRes
                });

                vmap.addLayer(wfs_layer);

            }

            initMap();


            $.getJSON('assets.json', function(data) {
                //console.log(data);
                assets_array = data;

                $("#e1").select2({
                    data: assets_array
                }).on("change", function(e) {

                        // Removing the previous layers
                        var layerToRemove = vmap.getLayersByName("WMS weed");
                        if (layerToRemove.length)
                        {
                            // By construction, there is only one WMS layer with this name
                            vmap.removeLayer(layerToRemove[0]);
                        }


                        // Adding the new ones
                        var bwms = new OpenLayers.Layer.WMS( "WMS weed",
                            "/geoserver/PROJECT1/wms?",
                            {
                                "transparent":"true",
                                "layers":"CURRENT_OCCURENCE",
                                "format":"image/png8",
                                "viewparams":"asset_code:"+e.added.code
                            },{
                                isBaseLayer: false,
                                singleTile:true,
                                transitionEffect: 'resize'
                            }
                        );

                        // Add WMS layer to our map
                        vmap.addLayer(bwms);

                });

            });

        });
    </script>
  </body>
</html>